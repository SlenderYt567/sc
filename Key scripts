--[[
    ScriptForge AI - Tapping Haven Auto Farm (Versão Final 4.0)
    Language: Luau
    Library: Rayfield UI
    Status: Undetected / Optimized
]]

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- // SERVIÇOS E VARIÁVEIS // --
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer

-- // LOCALIZAÇÃO DOS REMOTES // --
-- Tenta encontrar as pastas com segurança
local Remotes = ReplicatedStorage:WaitForChild("Remotes", 10)
local Events = Remotes and Remotes:WaitForChild("Events", 10)
local Functions = Remotes and Remotes:WaitForChild("Functions", 10)

if not Events or not Functions then
    Rayfield:Notify({Title = "Erro", Content = "Não foi possível carregar os Remotes. Tente entrar no jogo novamente.", Duration = 5})
    return
end

-- Definição dos Remotes
local ClickRemote = Events:WaitForChild("ClickEvent")
local RebirthRemote = Events:WaitForChild("Rebirth")
local BuyEggRemote = Events:WaitForChild("BuyEgg")
local MerchantBuyRemote = Events:WaitForChild("MerchantBuy")
local RequestStocksFunc = Functions:WaitForChild("RequestStocks")
local PurchaseItemFunc = Functions:WaitForChild("PurchaseItem")

-- // LISTA DE OVOS (Baseada nos seus códigos) // --
local EggList = {
    "Common Egg",
    "Rare Egg",
    "Rich Egg",
    "Mushroom Egg",
    "Beach Egg",
    "Magma Egg",
    "Desert Egg",
    "Magma Soul Egg",
    "Release Egg"
}

-- // VARIÁVEIS DE CONTROLE (FLAGS) // --
local Flags = {
    AutoClick = false,
    AutoRebirth = false,
    AutoHatch = false,
    AutoBuyMerchant = false,
    SelectedEgg = "Common Egg",
    HatchMode = "Max" -- Opções: Single, Triple, Max
}

-- // INTERFACE (UI) // --
local Window = Rayfield:CreateWindow({
   Name = "ScriptForge | Tapping Haven",
   LoadingTitle = "Carregando...",
   LoadingSubtitle = "Auto Farm & Merchant V4",
   ConfigurationSaving = { Enabled = true, FileName = "SF_TappingHaven_Config" },
   KeySystem = false,
})

-- === ABA 1: FARM PRINCIPAL === --
local TabFarm = Window:CreateTab("Farm", 4483362458)
local SectionFarm = TabFarm:CreateSection("Automação")

TabFarm:CreateToggle({
   Name = "Auto Click (Velocidade Máxima)",
   CurrentValue = false,
   Flag = "ToggleClick",
   Callback = function(Value)
        Flags.AutoClick = Value
   end,
})

TabFarm:CreateToggle({
   Name = "Auto Rebirth",
   CurrentValue = false,
   Flag = "ToggleRebirth",
   Callback = function(Value)
        Flags.AutoRebirth = Value
   end,
})

-- === ABA 2: OVOS (EGGS) === --
local TabEggs = Window:CreateTab("Eggs", 4483362458)
TabEggs:CreateSection("Sistema de Hatch")

TabEggs:CreateDropdown({
   Name = "Escolher Ovo",
   Options = EggList,
   CurrentOption = {"Common Egg"},
   MultipleOptions = false,
   Flag = "EggSelect",
   Callback = function(Option)
       Flags.SelectedEgg = Option[1]
   end,
})

TabEggs:CreateDropdown({
   Name = "Modo de Abertura",
   Options = {"Single", "Triple", "Max"},
   CurrentOption = {"Max"},
   MultipleOptions = false,
   Flag = "ModeSelect",
   Callback = function(Option)
       Flags.HatchMode = Option[1]
   end,
})

TabEggs:CreateToggle({
   Name = "Ativar Auto Hatch",
   CurrentValue = false,
   Flag = "ToggleHatch",
   Callback = function(Value)
       Flags.AutoHatch = Value
   end,
})

-- === ABA 3: MERCHANT & SHOP === --
local TabMerchant = Window:CreateTab("Merchant/Shop", 4483362458)
TabMerchant:CreateSection("Merchant Sniper")

TabMerchant:CreateToggle({
   Name = "Auto Buy Merchant (Compra Tudo)",
   CurrentValue = false,
   Flag = "ToggleMerchant",
   Callback = function(Value)
       Flags.AutoBuyMerchant = Value
   end,
})
TabMerchant:CreateParagraph({Title = "Info", Content = "Isso irá comprar automaticamente todos os estoques do Mercador Viajante se você tiver dinheiro."})

TabMerchant:CreateSection("Token Shop Exploit")
TabMerchant:CreateInput({
   Name = "Comprar Item por Tokens",
   PlaceholderText = "Nome do Item (ex: VIP)",
   RemoveTextAfterFocusLost = false,
   Callback = function(Text)
       -- Tenta comprar usando Tokens em vez de Robux
       pcall(function()
           PurchaseItemFunc:InvokeServer("Tokens", Text)
           Rayfield:Notify({Title = "Comando Enviado", Content = "Tentando comprar " .. Text .. " com Tokens.", Duration = 3})
       end)
   end,
})

-- === ABA 4: PLAYER === --
local TabPlayer = Window:CreateTab("Local", 4483362458)
TabPlayer:CreateSlider({
   Name = "Velocidade (WalkSpeed)",
   Range = {16, 300},
   Increment = 1,
   CurrentValue = 16,
   Callback = function(Value)
       if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
           LocalPlayer.Character.Humanoid.WalkSpeed = Value
       end
   end,
})

TabPlayer:CreateButton({
   Name = "Ativar Anti-AFK",
   Callback = function()
       LocalPlayer.Idled:Connect(function()
           VirtualUser:CaptureController()
           VirtualUser:ClickButton2(Vector2.new())
       end)
       Rayfield:Notify({Title = "Anti-AFK", Content = "Ativado!", Duration = 3})
   end,
})

-- // LÓGICA DE LOOP (OTIMIZADA) // --

-- 1. Loop de Click (Heartbeat - Executa a cada frame físico do servidor)
RunService.Heartbeat:Connect(function()
    if Flags.AutoClick then
        pcall(function()
            ClickRemote:FireServer()
        end)
    end
end)

-- 2. Loop de Rebirth e Eggs
task.spawn(function()
    while true do
        task.wait(0.1) -- Pequeno delay para estabilidade
        
        -- Auto Rebirth
        if Flags.AutoRebirth then
            pcall(function()
                RebirthRemote:FireServer()
            end)
        end

        -- Auto Hatch
        if Flags.AutoHatch and Flags.SelectedEgg then
            pcall(function()
                BuyEggRemote:FireServer(Flags.SelectedEgg, Flags.HatchMode)
            end)
        end
    end
end)

-- 3. Loop do Merchant (Verifica a cada 2 segundos)
task.spawn(function()
    while true do
        task.wait(2)
        if Flags.AutoBuyMerchant then
            pcall(function()
                -- Pede a lista de itens ao servidor
                local stockData = RequestStocksFunc:InvokeServer("All")
                if stockData then
                    for merchantName, items in pairs(stockData) do
                        for itemName, data in pairs(items) do
                            -- Se não for o contador de tempo e tiver estoque
                            if itemName ~= "RestockIn" and type(data) == "table" and data.Stock and data.Stock > 0 then
                                MerchantBuyRemote:FireServer(merchantName, tostring(itemName))
                            end
                        end
                    end
                end
            end)
        end
    end
end)

Rayfield:Notify({
    Title = "ScriptForge AI",
    Content = "Script Carregado com Sucesso!",
    Duration = 5,
    Image = 4483362458,
})