--[[
    ScriptForge AI - Tapping Haven Auto Farm (Versão 5.0 - Merchant Fix)
    Status: WORKING
    Updates:
    - Auto Click (Heartbeat Speed)
    - Auto Eggs (Nomes Reais)
    - Merchant Auto Buy (Baseado no snippet "Boosts1", "1")
]]

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- // SERVIÇOS // --
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer

-- // LOCALIZAÇÃO DOS REMOTES // --
local Remotes = ReplicatedStorage:WaitForChild("Remotes", 10)
local Events = Remotes and Remotes:WaitForChild("Events", 10)
local Functions = Remotes and Remotes:WaitForChild("Functions", 10)

if not Events or not Functions then
    Rayfield:Notify({Title = "Erro", Content = "Remotes não encontrados!", Duration = 5})
    return
end

-- Remotes
local ClickRemote = Events:WaitForChild("ClickEvent")
local RebirthRemote = Events:WaitForChild("Rebirth")
local BuyEggRemote = Events:WaitForChild("BuyEgg")
local MerchantBuyRemote = Events:WaitForChild("MerchantBuy")
local RequestStocksFunc = Functions:WaitForChild("RequestStocks")
local PurchaseItemFunc = Functions:WaitForChild("PurchaseItem")

-- // DADOS // --
local EggList = {
    "Common Egg", "Rare Egg", "Rich Egg", "Mushroom Egg", 
    "Beach Egg", "Magma Egg", "Desert Egg", "Magma Soul Egg", "Release Egg"
}

local Flags = {
    AutoClick = false,
    AutoRebirth = false,
    AutoHatch = false,
    AutoBuyMerchant = false,
    SelectedEgg = "Common Egg",
    HatchMode = "Max"
}

-- // INTERFACE // --
local Window = Rayfield:CreateWindow({
   Name = "ScriptForge | Tapping Haven",
   LoadingTitle = "Versão 5.0",
   LoadingSubtitle = "Merchant Fix & Speed",
   ConfigurationSaving = { Enabled = true, FileName = "SF_Haven_V5" },
   KeySystem = false,
})

-- === ABA FARM === --
local TabFarm = Window:CreateTab("Farm", 4483362458)

TabFarm:CreateToggle({
   Name = "Auto Click (Extremo)",
   CurrentValue = false,
   Flag = "AutoClick",
   Callback = function(v) Flags.AutoClick = v end,
})

TabFarm:CreateToggle({
   Name = "Auto Rebirth",
   CurrentValue = false,
   Flag = "AutoRebirth",
   Callback = function(v) Flags.AutoRebirth = v end,
})

-- === ABA EGGS === --
local TabEggs = Window:CreateTab("Eggs", 4483362458)

TabEggs:CreateDropdown({
   Name = "Ovo", Options = EggList, CurrentOption = {"Common Egg"},
   Callback = function(v) Flags.SelectedEgg = v[1] end,
})

TabEggs:CreateDropdown({
   Name = "Modo", Options = {"Single", "Triple", "Max"}, CurrentOption = {"Max"},
   Callback = function(v) Flags.HatchMode = v[1] end,
})

TabEggs:CreateToggle({
   Name = "Auto Hatch", CurrentValue = false,
   Callback = function(v) Flags.AutoHatch = v end,
})

-- === ABA MERCHANT (ATUALIZADA) === --
local TabMerchant = Window:CreateTab("Merchant", 4483362458)
TabMerchant:CreateSection("Merchant Sniper")

TabMerchant:CreateToggle({
   Name = "Auto Buy Merchant (Compra Tudo)",
   CurrentValue = false,
   Flag = "AutoBuyMerch",
   Callback = function(v) Flags.AutoBuyMerchant = v end,
})

TabMerchant:CreateParagraph({
    Title = "Como funciona?", 
    Content = "O script detecta o Mercador atual (ex: Boosts1) e varre os itens 1, 2, 3... comprando automaticamente se tiver estoque."
})

TabMerchant:CreateButton({
    Name = "Forçar Compra Item 1 (Boosts1)",
    Callback = function()
        -- Código exato fornecido por você como fallback
        local args = {"Boosts1", "1"}
        MerchantBuyRemote:FireServer(unpack(args))
        Rayfield:Notify({Title = "Comando Enviado", Content = "Comprou Item 1 de Boosts1", Duration = 2})
    end
})

-- === PLAYER & AFK === --
local TabPlayer = Window:CreateTab("Misc", 4483362458)
TabPlayer:CreateSlider({
   Name = "Speed", Range = {16, 300}, Increment = 1, CurrentValue = 16,
   Callback = function(v) 
       if LocalPlayer.Character then LocalPlayer.Character.Humanoid.WalkSpeed = v end 
   end,
})

-- // LOOP PRINCIPAL // --

-- 1. Click Loop (Máxima Velocidade - Heartbeat)
RunService.Heartbeat:Connect(function()
    if Flags.AutoClick then
        pcall(function() ClickRemote:FireServer() end)
    end
end)

-- 2. Hatch e Rebirth Loop
task.spawn(function()
    while true do
        task.wait(0.1)
        if Flags.AutoRebirth then pcall(function() RebirthRemote:FireServer() end) end
        if Flags.AutoHatch then pcall(function() BuyEggRemote:FireServer(Flags.SelectedEgg, Flags.HatchMode) end) end
    end
end)

-- 3. MERCHANT LOGIC (Inteligente)
task.spawn(function()
    while true do
        task.wait(1.5) -- Verifica a cada 1.5s para não lagar
        if Flags.AutoBuyMerchant then
            pcall(function()
                -- Pede os dados de todos os merchants
                local allStocks = RequestStocksFunc:InvokeServer("All")
                
                if allStocks then
                    -- Itera sobre os merchants (ex: "Boosts1", "PetShop", etc)
                    for merchantName, items in pairs(allStocks) do
                        if type(items) == "table" then
                            -- Itera sobre os itens dentro do merchant (1, 2, 3...)
                            for itemId, itemData in pairs(items) do
                                -- Verifica se não é dado de tempo ("RestockIn") e se tem estoque
                                if itemId ~= "RestockIn" and type(itemData) == "table" then
                                    if itemData.Stock and itemData.Stock > 0 then
                                        -- Dispara o evento: NomeDoMerchant, ID (String)
                                        -- Ex: FireServer("Boosts1", "1")
                                        MerchantBuyRemote:FireServer(merchantName, tostring(itemId))
                                    end
                                end
                            end
                        end
                    end
                end
            end)
        end
    end
end)

-- Anti-AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

Rayfield:Notify({Title = "ScriptForge", Content = "Merchant System Atualizado!", Duration = 3})