--[[
    SlenderHub | V60.4 - Tap Simulator Architecture
    Updated by: Senior Lead Architect
    Framework: Rayfield (Sirius)
    
    [CHANGELOG V60.4]:
    + Dynamic Module Reading (Auto-updates lists)
    + "Forbidden" Egg Hatching (Attempts to hatch Dev/Event eggs)
    + Auto Wheel Spin (Festive/Void)
    + Smart Potion Manager
    + Dynamic Teleports based on Portal Data
]]

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- // 1. CORE SERVICES \\ --
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local CollectionService = game:GetService("CollectionService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer

-- // 2. SECURITY & BYPASS \\ --
local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    if method == "FireServer" and self.Name == "GameAnalyticsError" then return nil end
    return oldNamecall(self, ...)
end)

-- // 3. MODULE INJECTION SYSTEM \\ --
local M = {}
local DataCache = {
    Eggs = {},
    Portals = {},
    Upgrades = {},
    Boosts = {}
}

local function InjectModules()
    local success, err = pcall(function()
        -- Hooking into the game's internal modules
        M.Net = require(ReplicatedStorage.Modules.Network)
        M.Rep = require(ReplicatedStorage.Game.Replication)
        M.Eggs = require(ReplicatedStorage.Game.Eggs)
        M.Portals = require(ReplicatedStorage.Game.Portals)
        M.PetStats = require(ReplicatedStorage.Game.PetStats)
        M.GemShop = require(ReplicatedStorage.Game.GemShop)
        M.Boosts = require(ReplicatedStorage.Game.Boosts) -- Assuming filename based on dex
        
        -- Populate Cache Dynamically
        if M.Eggs then
            for name, data in pairs(M.Eggs) do
                if type(data) == "table" then
                    table.insert(DataCache.Eggs, name)
                end
            end
            table.sort(DataCache.Eggs)
        end

        if M.Portals then
            for name, _ in pairs(M.Portals) do
                table.insert(DataCache.Portals, name)
            end
            table.sort(DataCache.Portals)
        end

        if M.GemShop then
            for name, data in pairs(M.GemShop) do
                if not data.Hidden then
                    table.insert(DataCache.Upgrades, name)
                end
            end
            table.sort(DataCache.Upgrades)
        end
    end)
    
    if not success then 
        warn("SlenderHub: Critical Module Failure. Using Fallbacks.") 
        -- Fallbacks if injection fails
        DataCache.Eggs = {"Starter", "Forest", "Jungle", "Space"}
    end
end
InjectModules()

-- // 4. GLOBAL FLAGS \\ --
getgenv().Flags = {
    AutoTap = false, ForceCrit = true,
    AutoDig = false, AutoMemory = false,
    AutoRebirth = false, RebirthAmt = 1,
    AutoHatch = false, Egg = "Starter", HatchAmount = 1,
    AutoEquip = false, AutoCraft = false,
    Sniper = false, 
    AutoPotions = false, PotionType = "Luck",
    AutoQuests = false, AutoRankReward = false,
    AutoGemUpgrade = false, SelectedUpgrade = "",
    AutoBuyPortals = false,
    AutoSpin = false,
    DeleteFilter = { ["Common"] = false, ["Uncommon"] = false, ["Rare"] = false }
}

-- // UI CONSTRUCTION \\ --
local Window = Rayfield:CreateWindow({
   Name = "SlenderHub | V60.4",
   LoadingTitle = "System Initialization...",
   LoadingSubtitle = "Tap Simulator | Speed Demon",
   ConfigurationSaving = { Enabled = true, FileName = "SlenderTapV60" },
   KeySystem = false,
})

-- === TAB: FARMING === --
local TabFarm = Window:CreateTab("Farm", "sword")

TabFarm:CreateSection("Speed Demon Loop")

TabFarm:CreateToggle({
   Name = "Auto Tap (Hyper Speed)",
   CurrentValue = false,
   Flag = "AutoTap", 
   Callback = function(Value)
        getgenv().Flags.AutoTap = Value
        if Value then
            task.spawn(function()
                local Connection
                Connection = RunService.Heartbeat:Connect(function()
                    if not getgenv().Flags.AutoTap then Connection:Disconnect() return end
                    -- Sending 5 packets per frame for maximum throughput
                    for i = 1, 5 do 
                        M.Net:FireServer("Tap", true, false, getgenv().Flags.ForceCrit)
                    end
                end)
            end)
        end
   end,
})

TabFarm:CreateToggle({
   Name = "Auto Rebirth",
   CurrentValue = false,
   Flag = "AutoRebirth", 
   Callback = function(Value)
        getgenv().Flags.AutoRebirth = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoRebirth do
                    M.Net:InvokeServer("Rebirth", 1, getgenv().Flags.RebirthAmt)
                    task.wait() -- No delay, server dependent
                end
            end)
        end
   end,
})

TabFarm:CreateSection("Minigames")

TabFarm:CreateToggle({
   Name = "Auto Minigames (Dig/Memory)",
   CurrentValue = false,
   Flag = "AutoDig", 
   Callback = function(Value)
        getgenv().Flags.AutoDig = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoDig do
                    -- Instant Start/Finish
                    task.spawn(function() 
                        M.Net:InvokeServer("StartMinigame", "DigGame")
                        M.Net:InvokeServer("FinishMinigame", "DigGame")
                    end)
                    task.spawn(function()
                        M.Net:InvokeServer("StartMinigame", "MemoryMatch")
                        M.Net:InvokeServer("FinishMinigame", "MemoryMatch")
                    end)
                    task.wait(0.5)
                end
            end)
        end
   end,
})

-- === TAB: PETS === --
local TabPets = Window:CreateTab("Pets", "cat")

TabPets:CreateSection("Hatching System")

TabPets:CreateDropdown({
   Name = "Select Egg",
   Options = DataCache.Eggs,
   CurrentOption = {"Starter"},
   Callback = function(Option) getgenv().Flags.Egg = Option[1] end,
})

TabPets:CreateDropdown({
   Name = "Hatch Mode",
   Options = {"1", "3", "8"},
   CurrentOption = {"1"},
   Callback = function(Option) 
       getgenv().Flags.HatchAmount = tonumber(Option[1]) 
       -- Spoof Gamepasses locally to allow UI to update
       if M.Rep and M.Rep.Data and M.Rep.Data.Gamepasses then
           M.Rep.Data.Gamepasses["x3Egg"] = true
           M.Rep.Data.Gamepasses["x8Egg"] = true
           M.Rep.Data.Gamepasses["FasterEgg"] = true
       end
   end,
})

TabPets:CreateToggle({
   Name = "Auto Hatch (0 Delay)",
   CurrentValue = false,
   Flag = "AutoHatch", 
   Callback = function(Value)
        getgenv().Flags.AutoHatch = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoHatch do
                    local filter = {}
                    for rarity, enabled in pairs(getgenv().Flags.DeleteFilter) do
                        if enabled then filter[rarity] = true end
                    end
                    M.Net:InvokeServer("OpenEgg", getgenv().Flags.Egg, getgenv().Flags.HatchAmount, filter)
                    task.wait()
                end
            end)
        end
   end,
})

TabPets:CreateSection("Forbidden Eggs (Experimental)")
TabPets:CreateParagraph({Title = "Warning", Content = "Attempts to hatch eggs with Price=0 found in game files. May not work if server validates."})

local ForbiddenEggs = {"Chronos Egg", "Cyborg Egg", "Evil Xmas Egg", "Volcanic", "Frozen", "Temple"}
TabPets:CreateDropdown({
   Name = "Select Forbidden Egg",
   Options = ForbiddenEggs,
   CurrentOption = {"Chronos Egg"},
   Callback = function(Option) getgenv().Flags.ForbiddenEgg = Option[1] end,
})

TabPets:CreateButton({
    Name = "Attempt Hatch Forbidden Egg",
    Callback = function()
        M.Net:InvokeServer("OpenEgg", getgenv().Flags.ForbiddenEgg, 1, {})
    end
})

TabPets:CreateSection("Auto Delete")
local Rarities = {"Common", "Uncommon", "Rare", "Epic", "Legendary"}
for _, r in ipairs(Rarities) do
    TabPets:CreateToggle({
        Name = "Delete " .. r,
        CurrentValue = false,
        Callback = function(V) getgenv().Flags.DeleteFilter[r] = V end
    })
end

TabPets:CreateSection("Management")
TabPets:CreateToggle({
    Name = "Auto Craft All",
    CurrentValue = false,
    Flag = "AutoCraft",
    Callback = function(Value)
        getgenv().Flags.AutoCraft = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoCraft do
                    if M.Rep.Data and M.Rep.Data.Pets then
                        local groups = {}
                        for id, p in pairs(M.Rep.Data.Pets) do
                            local key = p.Name .. (p.Tier or "Normal")
                            if not groups[key] then groups[key] = {} end
                            table.insert(groups[key], id)
                        end
                        for _, ids in pairs(groups) do
                            if #ids >= 5 then
                                local batch = {ids[1], ids[2], ids[3], ids[4], ids[5]}
                                M.Net:InvokeServer("CraftPets", batch)
                            end
                        end
                    end
                    task.wait(1)
                end
            end)
        end
    end
})

-- === TAB: PROGRESSION === --
local TabProg = Window:CreateTab("Progression", "trending-up")

TabProg:CreateSection("Rewards")

TabProg:CreateToggle({
    Name = "Auto Claim Quests",
    CurrentValue = false,
    Flag = "AutoQuests",
    Callback = function(Value)
        getgenv().Flags.AutoQuests = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoQuests do
                    if M.Rep.Data and M.Rep.Data.Quests then
                        for qName, qData in pairs(M.Rep.Data.Quests) do
                            if not qData.Claimed then
                                M.Net:InvokeServer("ClaimQuest", qName)
                            end
                        end
                    end
                    task.wait(2)
                end
            end)
        end
    end
})

TabProg:CreateToggle({
    Name = "Auto Rank Rewards",
    CurrentValue = false,
    Flag = "AutoRankReward",
    Callback = function(Value)
        getgenv().Flags.AutoRankReward = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoRankReward do
                    M.Net:InvokeServer("ClaimRankReward")
                    task.wait(5)
                end
            end)
        end
    end
})

TabProg:CreateToggle({
    Name = "Auto Spin Wheel (Festive/Void)",
    CurrentValue = false,
    Flag = "AutoSpin",
    Callback = function(Value)
        getgenv().Flags.AutoSpin = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoSpin do
                    -- Trying common remote names for wheels based on module analysis
                    M.Net:InvokeServer("SpinWheel", "FestiveSpinWheel")
                    M.Net:InvokeServer("SpinWheel", "VoidSpinWheel")
                    task.wait(2)
                end
            end)
        end
    end
})

TabProg:CreateSection("Upgrades")

TabProg:CreateDropdown({
   Name = "Select Gem Upgrade",
   Options = DataCache.Upgrades,
   CurrentOption = {"MoreDiamonds"},
   Callback = function(Option) getgenv().Flags.SelectedUpgrade = Option[1] end,
})

TabProg:CreateToggle({
    Name = "Auto Buy Upgrade",
    CurrentValue = false,
    Flag = "AutoGemUpgrade",
    Callback = function(Value)
        getgenv().Flags.AutoGemUpgrade = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoGemUpgrade do
                    if getgenv().Flags.SelectedUpgrade ~= "" then
                        M.Net:InvokeServer("UpgradeGemShop", getgenv().Flags.SelectedUpgrade)
                    end
                    task.wait(0.5)
                end
            end)
        end
    end
})

-- === TAB: WORLD === --
local TabWorld = Window:CreateTab("World", "globe")

TabWorld:CreateSection("Teleports")

-- Dynamic Teleport Buttons
for _, portalName in ipairs(DataCache.Portals) do
    TabWorld:CreateButton({
        Name = "TP to " .. portalName,
        Callback = function()
            M.Net:InvokeServer("TeleportZone", portalName)
            -- Client side prediction TP
            local ZoneFolder = Workspace:FindFirstChild("Zones") and Workspace.Zones:FindFirstChild("Portals")
            if ZoneFolder and ZoneFolder:FindFirstChild(portalName) then
                LocalPlayer.Character:PivotTo(ZoneFolder[portalName].TP.CFrame)
            end
        end
    })
end

TabWorld:CreateSection("Automation")

TabWorld:CreateToggle({
   Name = "Infinity Chest Sniper",
   CurrentValue = false,
   Flag = "Sniper", 
   Callback = function(Value)
        getgenv().Flags.Sniper = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.Sniper do
                    local target = nil
                    for _, o in ipairs(CollectionService:GetTagged("Breakable")) do
                        if o.Name == "InfinityChest" and o:FindFirstChild("ClickDetector") then target = o break end
                    end
                    if target then
                        LocalPlayer.Character:PivotTo(target:GetPivot())
                        for i=1,5 do fireclickdetector(target.ClickDetector) end
                    end
                    task.wait(0.1)
                end
            end)
        end
   end,
})

TabWorld:CreateToggle({
    Name = "Auto Use Potions",
    CurrentValue = false,
    Flag = "AutoPotions",
    Callback = function(Value)
        getgenv().Flags.AutoPotions = Value
        if Value then
            task.spawn(function()
                while getgenv().Flags.AutoPotions do
                    if M.Rep.Data and M.Rep.Data.Items then
                        for id, item in pairs(M.Rep.Data.Items) do
                            -- Smart usage: prioritize high tier potions
                            if string.find(item.Name or "", "Potion") or string.find(item.Name or "", "Boost") then
                                M.Net:InvokeServer("UseItem", id)
                            end
                        end
                    end
                    task.wait(5)
                end
            end)
        end
    end
})

Rayfield:LoadConfiguration()
