--[[
    SlenderHub Remote Spy V3.1 - With VeLink Key System
    Architect: SlenderHub Senior Developer
    UI Library: SlenderWind V5
    Features: Hybrid Hook System + VeLink Authentication
]]

-- Singleton Check
if getgenv().SlenderHubSpyLoaded then return end
getgenv().SlenderHubSpyLoaded = true

-- Services
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- VeLink Configuration
local VELINK_CONFIG = {
    CHECK_URL = "https://velink.to/api/public/check/key",
    KEY_URL = "https://velink.to/u/678807"
}

-- SlenderWind UI Library
local SlenderWind = loadstring(game:HttpGet("https://raw.githubusercontent.com/SlenderYt567/sc/refs/heads/main/SlenderWindV5.lua"))()

-- Key Validation Function
local function ValidateKey(key)
    local requestFunc = (syn and syn.request) or (http and http.request) or http_request or request
    if not requestFunc then return false end
    
    local url = VELINK_CONFIG.CHECK_URL .. "?key=" .. key
    local response = requestFunc({Url = url, Method = "GET"})
    
    if response and response.StatusCode == 200 then
        local success, data = pcall(function() return HttpService:JSONDecode(response.Body) end)
        if success and data and data.expired == false then
            return true
        end
    end
    return false
end

-- Create Key System Window
local KeyWindow = SlenderWind.Window({
    Name = "SlenderHub Remote Spy",
    KeySystem = false,
    Theme = { Accent = Color3.fromRGB(255, 85, 85) }
})

local KeyTab = KeyWindow:Tab("Authentication")

KeyTab:Paragraph("Access Required", "Enter a valid VeLink key to use Remote Spy.\nKeys are valid for 24 hours.")

local keyInput = ""
KeyTab:Input("Enter Key", "VELINK-XXXXX-XXXXX", "KeyInput", "Paste your key here", function(text)
    keyInput = text:gsub("%s+", "")
end)

KeyTab:Button("ðŸ”“ Verify Key", "Validate and unlock Remote Spy", function()
    if #keyInput < 5 then
        KeyWindow:Notify("Error", "Please enter a valid key", 2)
        return
    end
    
    KeyWindow:Notify("Checking...", "Validating key with VeLink API...", 2)
    
    local isValid = ValidateKey(keyInput)
    
    if isValid then
        KeyWindow:Notify("Success!", "Key validated! Loading Remote Spy...", 2)
        task.wait(1)
        
        -- Destroy key window
        pcall(function()
            for _, ui in pairs(game.CoreGui:GetChildren()) do
                if ui.Name:find("Slender") then ui:Destroy() end
            end
        end)
        
        task.wait(0.3)
        
        -- Load Main Remote Spy
        LoadRemoteSpy()
    else
        KeyWindow:Notify("Invalid Key", "Key expired or does not exist", 3)
    end
end)

KeyTab:Section("Get Key")

KeyTab:Button("ðŸ”‘ Get Free Key (24h)", "Copy link to get key", function()
    if setclipboard then
        setclipboard(VELINK_CONFIG.KEY_URL)
        KeyWindow:Notify("Copied!", "Link copied to clipboard", 2)
    else
        KeyWindow:Notify("Link", VELINK_CONFIG.KEY_URL, 5)
    end
end)

-- ==========================================
-- MAIN REMOTE SPY FUNCTION
-- ==========================================

function LoadRemoteSpy()
    -- Global State
    getgenv().SlenderSpy = {
        Enabled = false,
        Logs = {},
        MaxLogs = 100,
        Blocked = { 
            "CharacterSoundEvent", "UpdateMouse", "Move", "UpdateCharacter", 
            "GetServerTime", "TouchHeartbeat", "MainRemote"
        }
    }

    -- Serialization Engine
    local function GetPath(Obj)
        if not Obj or Obj == game then return "game" end
        local Hierarchy = {}
        local Current = Obj
        while Current.Parent ~= nil and Current.Parent ~= game do
            table.insert(Hierarchy, 1, Current)
            Current = Current.Parent
        end
        local Service = Current
        table.insert(Hierarchy, 1, Service)
        local PathStr = "game"
        for i, v in ipairs(Hierarchy) do
            if i == 1 then
                PathStr = PathStr .. ':GetService("' .. v.ClassName .. '")'
            else
                if v.Name:match("^[%a_][%w_]*$") then
                    PathStr = PathStr .. "." .. v.Name
                else
                    PathStr = PathStr .. '["' .. v.Name .. '"]'
                end
            end
        end
        return PathStr
    end

    local function SerializeType(v)
        local T = typeof(v)
        if T == "string" then
            return '"' .. v:gsub('"', '\\"'):gsub('\n', '\\n'):gsub('\r', '\\r') .. '"'
        elseif T == "number" then
            if v == math.huge then return "math.huge" end
            if v == -math.huge then return "-math.huge" end
            return tostring(v)
        elseif T == "boolean" then
            return tostring(v)
        elseif T == "Instance" then
            return GetPath(v)
        elseif T == "Vector3" then
            return string.format("Vector3.new(%g, %g, %g)", v.X, v.Y, v.Z)
        elseif T == "CFrame" then
            return string.format("CFrame.new(%g, %g, %g)", v.Position.X, v.Position.Y, v.Position.Z)
        elseif T == "Color3" then
            return string.format("Color3.fromRGB(%d, %d, %d)", v.R*255, v.G*255, v.B*255)
        elseif T == "nil" then
            return "nil"
        else
            return '"' .. tostring(v) .. '"'
        end
    end

    local function SerializeTable(tbl, indent, seen)
        seen = seen or {}
        if seen[tbl] then return "--[[Cyclic Reference]]" end
        seen[tbl] = true
        indent = indent or 0
        local result = "{\n"
        local padding = string.rep("    ", indent + 1)
        for k, v in pairs(tbl) do
            local key
            if type(k) == "string" and k:match("^[%a_][%w_]*$") then
                key = k
            else
                key = "[" .. SerializeType(k) .. "]"
            end
            local value
            if type(v) == "table" then
                value = SerializeTable(v, indent + 1, seen)
            else
                value = SerializeType(v)
            end
            result = result .. padding .. key .. " = " .. value .. ",\n"
        end
        result = result .. string.rep("    ", indent) .. "}"
        return result
    end

    local function GenerateScript(Log)
        if not Log then return "-- Erro: Log invÃ¡lido" end
        local Path = GetPath(Log.Instance)
        local ArgsStr = SerializeTable(Log.Args)
        local SourceInfo = Log.Source and ("-- Calling Script: " .. Log.Source) or "-- Calling Script: Unknown"
        local Script = "-- SlenderHub V3.1 Generated Code\n"
        Script = Script .. "-- Remote: " .. Log.Name .. "\n"
        Script = Script .. SourceInfo .. "\n"
        Script = Script .. "-- Executions: " .. Log.Count .. "\n\n"
        Script = Script .. "local args = " .. ArgsStr .. "\n\n"
        if Log.Method == "FireServer" then
            Script = Script .. Path .. ":FireServer(unpack(args))"
        else
            Script = Script .. "local result = " .. Path .. ":InvokeServer(unpack(args))\nprint(result)"
        end
        return Script
    end

    local function DeepCompare(t1, t2, depth)
        depth = depth or 0
        if depth > 10 then return false end
        if type(t1) ~= type(t2) then return false end
        if type(t1) ~= "table" then return t1 == t2 end
        for k, v in pairs(t1) do if not DeepCompare(v, t2[k], depth + 1) then return false end end
        for k, v in pairs(t2) do if not DeepCompare(v, t1[k], depth + 1) then return false end end
        return true
    end

    -- UI Construction
    local Window = SlenderWind.Window({
        Name = "SlenderHub Remote Spy V3.1",
        KeySystem = false,
        Theme = { Accent = Color3.fromRGB(255, 85, 85) }
    })

    local SelectedLogIndex = nil
    local CurrentScriptBuffer = ""
    local CodePreview = nil
    local LogList = nil

    local TabSpy = Window:Tab("Remote Spy")

    TabSpy:Section("Control Panel")

    TabSpy:Toggle("Enable Spy (Hybrid Hook)", false, "SpyEnabled", "Activates remote monitoring", function(Value)
        getgenv().SlenderSpy.Enabled = Value
        Window:Notify(Value and "Spy Active" or "Spy Disabled", Value and "Monitoring remotes..." or "Stopped monitoring", 2)
    end)

    TabSpy:Button("ðŸ—‘ï¸ Clear All Logs", "Clears all captured remotes", function()
        getgenv().SlenderSpy.Logs = {}
        SelectedLogIndex = nil
        CurrentScriptBuffer = ""
        if CodePreview then CodePreview:Set("") end
        Window:Notify("Cleared", "All logs removed", 1)
    end)

    TabSpy:Button("ðŸš« Reset Blacklist", "Resets blocked remotes", function()
        getgenv().SlenderSpy.Blocked = { 
            "CharacterSoundEvent", "UpdateMouse", "Move", "UpdateCharacter", 
            "GetServerTime", "TouchHeartbeat", "MainRemote"
        }
        Window:Notify("Reset", "Blacklist cleared", 1)
    end)

    TabSpy:Section("Remote Viewer")

    LogList = TabSpy:Dropdown("Select Remote", {"None"}, "None", "RemoteList", "Choose captured remote", function(val)
        if val == "None" then SelectedLogIndex = nil return end
        local ID = tonumber(val:match("^%[(%d+)%]"))
        if ID then SelectedLogIndex = ID end
    end)

    TabSpy:Button("ðŸ”„ Refresh List", "Updates remote list", function()
        local Options = {}
        local Logs = getgenv().SlenderSpy.Logs
        local Start = math.max(1, #Logs - 25)
        for i = #Logs, Start, -1 do
            local log = Logs[i]
            local MethodShort = (log.Method == "FireServer") and "Fire" or "Invoke"
            local Label = string.format("[%d] %s (%s) x%d", i, log.Name, MethodShort, log.Count)
            table.insert(Options, Label)
        end
        if #Options == 0 then Options = {"None"} end
        LogList:Refresh(Options, "None")
        Window:Notify("Updated", "List refreshed", 1)
    end)

    TabSpy:Section("Advanced Tools")

    TabSpy:Button("â›” Block Selected", "Adds remote to blacklist", function()
        if SelectedLogIndex and getgenv().SlenderSpy.Logs[SelectedLogIndex] then
            local Log = getgenv().SlenderSpy.Logs[SelectedLogIndex]
            table.insert(getgenv().SlenderSpy.Blocked, Log.Name)
            Window:Notify("Blocked", Log.Name .. " added to blacklist", 2)
        else
            Window:Notify("Error", "Select a remote first!", 2)
        end
    end)

    TabSpy:Button("âš¡ Instant Replay", "Re-executes selected remote", function()
        if SelectedLogIndex and getgenv().SlenderSpy.Logs[SelectedLogIndex] then
            local Log = getgenv().SlenderSpy.Logs[SelectedLogIndex]
            if Log.Instance then
                pcall(function()
                    if Log.Method == "FireServer" then
                        Log.Instance:FireServer(unpack(Log.Args))
                    elseif Log.Method == "InvokeServer" then
                        task.spawn(function() Log.Instance:InvokeServer(unpack(Log.Args)) end)
                    end
                end)
                Window:Notify("Replayed", "Remote executed again", 1)
            end
        else
            Window:Notify("Error", "Select a remote first!", 2)
        end
    end)

    TabSpy:Section("Code Generation")

    TabSpy:Button("â¬‡ï¸ GENERATE & PREVIEW â¬‡ï¸", "Creates Lua code from remote", function()
        if SelectedLogIndex and getgenv().SlenderSpy.Logs[SelectedLogIndex] then
            local Log = getgenv().SlenderSpy.Logs[SelectedLogIndex]
            local Code = GenerateScript(Log)
            CurrentScriptBuffer = Code
            if CodePreview then CodePreview:Set(Code) end
            Window:Notify("Generated", "Code created successfully!", 1)
        else
            Window:Notify("Error", "Select a remote first!", 2)
        end
    end)

    CodePreview = TabSpy:Input("Script Preview", "Generated code appears here...", "CodeBuffer", "Edit code before execution", function(Text)
        CurrentScriptBuffer = Text
    end)

    TabSpy:Button("ðŸ“‹ Copy to Clipboard", "Copies code to clipboard", function()
        if CurrentScriptBuffer ~= "" then
            if setclipboard then
                setclipboard(CurrentScriptBuffer)
                Window:Notify("Copied", "Code copied to clipboard!", 1)
            else
                Window:Notify("Error", "Clipboard not supported", 2)
            end
        else
            Window:Notify("Error", "No code to copy!", 2)
        end
    end)

    TabSpy:Button("â–¶ Execute Generated Code", "Runs the generated script", function()
        if CurrentScriptBuffer ~= "" then
            local success, result = pcall(function()
                local func, syntaxErr = loadstring(CurrentScriptBuffer)
                if not func then error(syntaxErr) end
                func()
            end)
            if success then
                Window:Notify("Success", "Script executed successfully", 1)
            else
                Window:Notify("Error", "Execution failed: " .. tostring(result), 3)
            end
        else
            Window:Notify("Error", "No code to execute!", 2)
        end
    end)

    -- Hook System
    local function ProcessLog(Instance, Method, Args)
        if not getgenv().SlenderSpy.Enabled then return end
        local RemoteName = Instance.Name
        for _, v in pairs(getgenv().SlenderSpy.Blocked) do
            if RemoteName == v then return end
        end
        local SrcScript = getcallingscript and getcallingscript()
        local SrcPath = "Unknown"
        if SrcScript then SrcPath = SrcScript:GetFullName() end
        local Logs = getgenv().SlenderSpy.Logs
        local LastLog = Logs[#Logs]
        if LastLog and LastLog.Instance == Instance and DeepCompare(LastLog.Args, Args) then
            LastLog.Count = LastLog.Count + 1
            LastLog.Time = os.date("%X")
        else
            table.insert(Logs, {
                Name = RemoteName,
                Instance = Instance,
                Method = Method,
                Args = Args,
                Source = SrcPath,
                Time = os.date("%X"),
                Count = 1
            })
            if #Logs > getgenv().SlenderSpy.MaxLogs then
                table.remove(Logs, 1)
            end
        end
    end

    local mt = getrawmetatable(game)
    local oldNamecall = mt.__namecall
    setreadonly(mt, false)
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        local args = {...}
        if (method == "FireServer" or method == "InvokeServer") then
            ProcessLog(self, method, args)
        end
        return oldNamecall(self, ...)
    end)
    setreadonly(mt, true)

    pcall(function()
        getgenv().SlenderSpy_OldFireServer = hookfunction(Instance.new("RemoteEvent").FireServer, newcclosure(function(self, ...)
            ProcessLog(self, "FireServer", {...})
            return getgenv().SlenderSpy_OldFireServer(self, ...)
        end))
        getgenv().SlenderSpy_OldInvokeServer = hookfunction(Instance.new("RemoteFunction").InvokeServer, newcclosure(function(self, ...)
            ProcessLog(self, "InvokeServer", {...})
            return getgenv().SlenderSpy_OldInvokeServer(self, ...)
        end))
    end)

    pcall(function()
        local Unreliable = Instance.new("UnreliableRemoteEvent")
        getgenv().SlenderSpy_OldUnreliableFire = hookfunction(Unreliable.FireServer, newcclosure(function(self, ...)
            ProcessLog(self, "FireServer", {...})
            return getgenv().SlenderSpy_OldUnreliableFire(self, ...)
        end))
    end)

    Window:Notify("SlenderHub Spy V3.1", "Remote monitoring active!", 3)
end
