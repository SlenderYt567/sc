-- // ============================================================
-- // SlenderHub V2.1 | Internal Remote Spy
-- // Architecture: Hybrid Hook + SlenderWind UI
-- // Dev: SlenderHub Chief Architect
-- // ============================================================

if getgenv().SlenderHubSpyLoaded then 
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "SlenderHub",
        Text = "Spy j√° est√° em execu√ß√£o!",
        Duration = 3
    })
    return 
end
getgenv().SlenderHubSpyLoaded = true

-- // Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- // Global State
getgenv().SlenderSpy = {
    Enabled = false,
    Logs = {},
    Blocked = {
        "CharacterSoundEvent", "UpdateMouse", "Move", "UpdateCharacter", 
        "GetServerTime", "TouchHeartbeat", "MainRemote", "ClientPulse"
    }
}

-- // ==========================================
-- // ENGINE: SERIALIZATION & PATH GENERATION
-- // ==========================================

local function GetPath(Obj)
    if not Obj or not Obj.Parent then return "nil" end
    if Obj == game then return "game" end
    
    local Hierarchy = {}
    local Current = Obj
    
    while Current.Parent ~= nil and Current.Parent ~= game do
        table.insert(Hierarchy, 1, Current)
        Current = Current.Parent
    end
    
    local Service = Current
    table.insert(Hierarchy, 1, Service)
    
    local PathStr = "game"
    
    for i, v in ipairs(Hierarchy) do
        if i == 1 then
            PathStr = PathStr .. ':GetService("' .. v.ClassName .. '")'
        else
            if v.Name:match("^[%a_][%w_]*$") then
                PathStr = PathStr .. "." .. v.Name
            else
                PathStr = PathStr .. '["' .. v.Name:gsub('"', '\\"') .. '"]'
            end
        end
    end
    
    return PathStr
end

local function SerializeType(v)
    local T = typeof(v)
    if T == "string" then
        return '"' .. v:gsub('"', '\\"') .. '"'
    elseif T == "number" then
        if v == math.huge then return "math.huge" end
        if v == -math.huge then return "-math.huge" end
        return tostring(v)
    elseif T == "boolean" then
        return tostring(v)
    elseif T == "Instance" then
        return GetPath(v)
    elseif T == "Vector3" then
        return string.format("Vector3.new(%s, %s, %s)", v.X, v.Y, v.Z)
    elseif T == "CFrame" then
        return string.format("CFrame.new(%s)", tostring(v))
    elseif T == "Color3" then
        return string.format("Color3.new(%s, %s, %s)", v.R, v.G, v.B)
    elseif T == "nil" then
        return "nil"
    else
        return '"[Unserializable: ' .. T .. ']"'
    end
end

local function SerializeTable(tbl, indent, seen)
    seen = seen or {}
    if seen[tbl] then return '"--[[Cyclic Reference]]"' end
    seen[tbl] = true
    
    indent = indent or 0
    local result = "{\n"
    local padding = string.rep("    ", indent + 1)
    
    for k, v in pairs(tbl) do
        local key
        if type(k) == "string" and k:match("^[%a_][%w_]*$") then
            key = k
        elseif type(k) == "number" then
            key = "[" .. k .. "]"
        else
            key = "[" .. SerializeType(k) .. "]"
        end
        
        local value
        if type(v) == "table" then
            value = SerializeTable(v, indent + 1, seen)
        else
            value = SerializeType(v)
        end
        
        result = result .. padding .. key .. " = " .. value .. ",\n"
    end
    
    result = result .. string.rep("    ", indent) .. "}"
    return result
end

local function GenerateScript(Log)
    if not Log then return "-- Error: Invalid Log" end
    
    local Path = GetPath(Log.Instance)
    local ArgsStr = SerializeTable(Log.Args)
    local SourceInfo = Log.Source and ("-- Calling Script: " .. Log.Source) or "-- Calling Script: Unknown"
    
    local Script = "-- // SlenderHub V2.1 Generated Code\n"
    Script = Script .. "-- Remote: " .. Log.Name .. "\n"
    Script = Script .. SourceInfo .. "\n"
    Script = Script .. "-- Calls Grouped: " .. Log.Count .. "\n\n"
    Script = Script .. "local args = " .. ArgsStr .. "\n\n"
    
    if Log.Method == "FireServer" then
        Script = Script .. Path .. ":FireServer(unpack(args))"
    elseif Log.Method == "InvokeServer" then
        Script = Script .. Path .. ":InvokeServer(unpack(args))"
    end
    
    return Script
end

local function DeepCompare(t1, t2)
    if type(t1) ~= type(t2) then return false end
    if type(t1) ~= "table" then return t1 == t2 end
    return #t1 == #t2 and tostring(t1[1]) == tostring(t2[1])
end

-- // ==========================================
-- // UI INTERFACE (SlenderWind)
-- // ==========================================

local SlenderWind = loadstring(game:HttpGet("https://raw.githubusercontent.com/SlenderYt567/sc/refs/heads/main/SlenderWindV5.lua"))()

local Window = SlenderWind.Window({
    Name = "SlenderHub V2.1 | Spy",
    KeySystem = false,
    Theme = { Accent = Color3.fromRGB(0, 255, 100) }
})

-- UI State
local SelectedLogIndex = nil
local CurrentScriptBuffer = ""
local CodeInput -- Forward declaration
local RemoteDropdown -- Forward declaration

-- // SECTION: CONTROLS
Window:Toggle({
    Name = "Ativar Spy (Hybrid Hook)",
    Default = false,
    Callback = function(Value)
        getgenv().SlenderSpy.Enabled = Value
    end
})

Window:Button({
    Name = "üóëÔ∏è Limpar Logs",
    Callback = function()
        getgenv().SlenderSpy.Logs = {}
        SelectedLogIndex = nil
        CurrentScriptBuffer = ""
        if CodeInput and CodeInput.Set then CodeInput:Set("") end
        
        -- Reset Dropdown
        if RemoteDropdown and RemoteDropdown.Refresh then
            RemoteDropdown:Refresh({"Nenhum"})
        end
    end
})

-- // SECTION: REMOTE LIST
RemoteDropdown = Window:Dropdown({
    Name = "Lista de Remotes",
    Options = {"Nenhum"},
    Callback = function(Value)
        if Value == "Nenhum" then 
            SelectedLogIndex = nil 
            return 
        end
        
        local ID = tonumber(Value:match("^%[(%d+)%]"))
        if ID then SelectedLogIndex = ID end
    end
})

Window:Button({
    Name = "üîÑ Atualizar Lista",
    Callback = function()
        local Options = {}
        local Logs = getgenv().SlenderSpy.Logs
        local Start = math.max(1, #Logs - 25) -- Mostra os √∫ltimos 25
        
        for i = #Logs, Start, -1 do
            local log = Logs[i]
            local MethodShort = (log.Method == "FireServer") and "Fire" or "Invoke"
            local Label = string.format("[%d] %s (%s) x%d", i, log.Name, MethodShort, log.Count)
            table.insert(Options, Label)
        end
        
        if #Options == 0 then Options = {"Nenhum"} end
        
        if RemoteDropdown and RemoteDropdown.Refresh then
            RemoteDropdown:Refresh(Options)
        end
    end
})

-- // SECTION: GENERATOR
Window:Button({
    Name = "‚¨áÔ∏è GERAR C√ìDIGO ‚¨áÔ∏è",
    Callback = function()
        if SelectedLogIndex and getgenv().SlenderSpy.Logs[SelectedLogIndex] then
            local Log = getgenv().SlenderSpy.Logs[SelectedLogIndex]
            local Code = GenerateScript(Log)
            CurrentScriptBuffer = Code
            
            if CodeInput and CodeInput.Set then 
                CodeInput:Set(Code) 
            end
        else
            game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Erro", Text = "Selecione um remote!"})
        end
    end
})

CodeInput = Window:Input({
    Name = "Output do Script",
    Default = "",
    Callback = function(Text)
        CurrentScriptBuffer = Text
    end
})

Window:Button({
    Name = "üìã Copiar para Clipboard",
    Callback = function()
        if CurrentScriptBuffer ~= "" then
            setclipboard(CurrentScriptBuffer)
            game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Sucesso", Text = "Copiado!"})
        end
    end
})

Window:Button({
    Name = "‚ñ∂ Executar C√≥digo",
    Callback = function()
        if CurrentScriptBuffer ~= "" then
            local success, err = pcall(function()
                loadstring(CurrentScriptBuffer)()
            end)
            if not success then
                warn(err)
                game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Erro", Text = "Veja o console (F9)"})
            else
                game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Executado", Text = "Script rodou com sucesso."})
            end
        end
    end
})

Window:Button({
    Name = "‚õî Bloquear Remote Selecionado",
    Callback = function()
        if SelectedLogIndex and getgenv().SlenderSpy.Logs[SelectedLogIndex] then
            local Log = getgenv().SlenderSpy.Logs[SelectedLogIndex]
            table.insert(getgenv().SlenderSpy.Blocked, Log.Name)
            game:GetService("StarterGui"):SetCore("SendNotification", {Title = "Bloqueado", Text = Log.Name .. " adicionado √† blacklist."})
        end
    end
})

-- // ==========================================
-- // CORE LOGIC: HYBRID HOOK SYSTEM
-- // ==========================================

local function ProcessLog(Instance, Method, Args)
    if not getgenv().SlenderSpy.Enabled then return end
    
    local RemoteName = Instance.Name
    for _, v in pairs(getgenv().SlenderSpy.Blocked) do
        if RemoteName == v then return end
    end

    local SrcScript = getcallingscript and getcallingscript()
    local SrcPath = SrcScript and SrcScript:GetFullName() or "Unknown"

    local Logs = getgenv().SlenderSpy.Logs
    local LastLog = Logs[#Logs]

    -- Deduplication
    if LastLog and LastLog.Instance == Instance and DeepCompare(LastLog.Args, Args) then
        LastLog.Count = LastLog.Count + 1
        LastLog.Time = os.date("%X")
    else
        table.insert(Logs, {
            Name = RemoteName,
            Instance = Instance,
            Method = Method,
            Args = Args,
            Source = SrcPath,
            Time = os.date("%X"),
            Count = 1
        })
    end
end

-- 1. Hook Metamethod (__namecall)
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    if (method == "FireServer" or method == "InvokeServer") then
        ProcessLog(self, method, {...})
    end
    return oldNamecall(self, ...)
end)

setreadonly(mt, true)

-- 2. Hook Function (Direct Calls - Anti-Bypass)
local OldFireServer
local OldInvokeServer

OldFireServer = hookfunction(Instance.new("RemoteEvent").FireServer, newcclosure(function(self, ...)
    ProcessLog(self, "FireServer", {...})
    return OldFireServer(self, ...)
end))

OldInvokeServer = hookfunction(Instance.new("RemoteFunction").InvokeServer, newcclosure(function(self, ...)
    ProcessLog(self, "InvokeServer", {...})
    return OldInvokeServer(self, ...)
end))

-- 3. UnreliableRemoteEvent Support
pcall(function()
    local Unreliable = Instance.new("UnreliableRemoteEvent")
    local OldUnreliableFire
    OldUnreliableFire = hookfunction(Unreliable.FireServer, newcclosure(function(self, ...)
        ProcessLog(self, "FireServer", {...})
        return OldUnreliableFire(self, ...)
    end))
end)

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "SlenderHub V2.1",
    Text = "Spy Initialized (SlenderWind UI)",
    Duration = 5
})
