--[[
    SlenderHub Remote Spy V3.0 - SlenderWind Edition
    Architect: SlenderHub Senior Developer
    UI Library: SlenderWind V10 (Internal)
    Features: Hybrid Hook System + Advanced Visualizer
]]

-- Singleton Check
if getgenv().SlenderHubSpyLoaded then 
    return 
end
getgenv().SlenderHubSpyLoaded = true

-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- SlenderWind UI Library
local SlenderWind = loadstring(game:HttpGet("https://raw.githubusercontent.com/SlenderYt567/sc/refs/heads/main/SlenderWindV5.lua"))()

-- Global State
getgenv().SlenderSpy = {
    Enabled = false,
    Logs = {},
    MaxLogs = 100,
    Blocked = { 
        "CharacterSoundEvent", "UpdateMouse", "Move", "UpdateCharacter", 
        "GetServerTime", "TouchHeartbeat", "MainRemote"
    }
}

-- ==========================================
-- ENGINE: SERIALIZATION & PATH GENERATION
-- ==========================================

local function GetPath(Obj)
    if not Obj or Obj == game then return "game" end
    
    local Hierarchy = {}
    local Current = Obj
    
    while Current.Parent ~= nil and Current.Parent ~= game do
        table.insert(Hierarchy, 1, Current)
        Current = Current.Parent
    end
    
    local Service = Current
    table.insert(Hierarchy, 1, Service)
    
    local PathStr = "game"
    
    for i, v in ipairs(Hierarchy) do
        if i == 1 then
            PathStr = PathStr .. ':GetService("' .. v.ClassName .. '")'
        else
            if v.Name:match("^[%a_][%w_]*$") then
                PathStr = PathStr .. "." .. v.Name
            else
                PathStr = PathStr .. '["' .. v.Name .. '"]'
            end
        end
    end
    
    return PathStr
end

local function SerializeType(v)
    local T = typeof(v)
    if T == "string" then
        return '"' .. v:gsub('"', '\\"'):gsub('\n', '\\n'):gsub('\r', '\\r') .. '"'
    elseif T == "number" then
        if v == math.huge then return "math.huge" end
        if v == -math.huge then return "-math.huge" end
        return tostring(v)
    elseif T == "boolean" then
        return tostring(v)
    elseif T == "Instance" then
        return GetPath(v)
    elseif T == "Vector3" then
        return string.format("Vector3.new(%g, %g, %g)", v.X, v.Y, v.Z)
    elseif T == "CFrame" then
        return string.format("CFrame.new(%g, %g, %g)", v.Position.X, v.Position.Y, v.Position.Z)
    elseif T == "Color3" then
        return string.format("Color3.fromRGB(%d, %d, %d)", v.R*255, v.G*255, v.B*255)
    elseif T == "nil" then
        return "nil"
    else
        return '"' .. tostring(v) .. '"'
    end
end

local function SerializeTable(tbl, indent, seen)
    seen = seen or {}
    if seen[tbl] then return "--[[Cyclic Reference]]" end
    seen[tbl] = true
    
    indent = indent or 0
    local result = "{\n"
    local padding = string.rep("    ", indent + 1)
    
    for k, v in pairs(tbl) do
        local key
        if type(k) == "string" and k:match("^[%a_][%w_]*$") then
            key = k
        else
            key = "[" .. SerializeType(k) .. "]"
        end
        
        local value
        if type(v) == "table" then
            value = SerializeTable(v, indent + 1, seen)
        else
            value = SerializeType(v)
        end
        
        result = result .. padding .. key .. " = " .. value .. ",\n"
    end
    
    result = result .. string.rep("    ", indent) .. "}"
    return result
end

local function GenerateScript(Log)
    if not Log then return "-- Erro: Log invÃ¡lido" end
    
    local Path = GetPath(Log.Instance)
    local ArgsStr = SerializeTable(Log.Args)
    local SourceInfo = Log.Source and ("-- Calling Script: " .. Log.Source) or "-- Calling Script: Unknown"
    
    local Script = "-- // SlenderHub V3.0 Generated Code\n"
    Script = Script .. "-- Remote: " .. Log.Name .. "\n"
    Script = Script .. SourceInfo .. "\n"
    Script = Script .. "-- Executions: " .. Log.Count .. "\n\n"
    Script = Script .. "local args = " .. ArgsStr .. "\n\n"
    
    if Log.Method == "FireServer" then
        Script = Script .. Path .. ":FireServer(unpack(args))"
    else
        Script = Script .. "local result = " .. Path .. ":InvokeServer(unpack(args))\nprint(result)"
    end
    
    return Script
end

-- ==========================================
-- ENGINE: COMPARISON (Deduplication)
-- ==========================================

local function DeepCompare(t1, t2, depth)
    depth = depth or 0
    if depth > 10 then return false end
    if type(t1) ~= type(t2) then return false end
    if type(t1) ~= "table" then return t1 == t2 end
    
    for k, v in pairs(t1) do if not DeepCompare(v, t2[k], depth + 1) then return false end end
    for k, v in pairs(t2) do if not DeepCompare(v, t1[k], depth + 1) then return false end end
    return true
end

-- ==========================================
-- SLENDERWIND UI CONSTRUCTION
-- ==========================================

local Window = SlenderWind.Window({
    Name = "SlenderHub Remote Spy V3.0",
    KeySystem = false,
    Theme = { 
        Accent = Color3.fromRGB(255, 85, 85) -- Red theme for spy
    }
})

-- UI State
local SelectedLogIndex = nil
local CurrentScriptBuffer = ""
local CodePreview = nil
local LogList = nil

-- Main Tab
local TabSpy = Window:Tab("Remote Spy")

TabSpy:Section("Control Panel")

TabSpy:Toggle("Enable Spy (Hybrid Hook)", false, "SpyEnabled", "Activates remote monitoring", function(Value)
    getgenv().SlenderSpy.Enabled = Value
    if Value then
        Window:Notify("Spy Active", "Monitoring remotes...", 2)
    else
        Window:Notify("Spy Disabled", "Stopped monitoring", 2)
    end
end)

TabSpy:Button("ðŸ—‘ï¸ Clear All Logs", "Clears all captured remotes", function()
    getgenv().SlenderSpy.Logs = {}
    SelectedLogIndex = nil
    CurrentScriptBuffer = ""
    if CodePreview then CodePreview:Set("") end
    Window:Notify("Cleared", "All logs removed", 1)
end)

TabSpy:Button("ðŸš« Reset Blacklist", "Resets blocked remotes", function()
    getgenv().SlenderSpy.Blocked = { 
        "CharacterSoundEvent", "UpdateMouse", "Move", "UpdateCharacter", 
        "GetServerTime", "TouchHeartbeat", "MainRemote"
    }
    Window:Notify("Reset", "Blacklist cleared", 1)
end)

TabSpy:Section("Remote Viewer")

LogList = TabSpy:Dropdown("Select Remote", {"None"}, "None", "RemoteList", "Choose captured remote", function(val)
    if val == "None" then 
        SelectedLogIndex = nil 
        return 
    end
    
    local ID = tonumber(val:match("^%[(%d+)%]"))
    if ID then SelectedLogIndex = ID end
end)

TabSpy:Button("ðŸ”„ Refresh List", "Updates remote list", function()
    local Options = {}
    local Logs = getgenv().SlenderSpy.Logs
    local Start = math.max(1, #Logs - 25)
    
    for i = #Logs, Start, -1 do
        local log = Logs[i]
        local MethodShort = (log.Method == "FireServer") and "Fire" or "Invoke"
        local Label = string.format("[%d] %s (%s) x%d", i, log.Name, MethodShort, log.Count)
        table.insert(Options, Label)
    end
    
    if #Options == 0 then Options = {"None"} end
    
    LogList:Refresh(Options, "None")
    Window:Notify("Updated", "List refreshed", 1)
end)

TabSpy:Section("Advanced Tools")

TabSpy:Button("â›” Block Selected", "Adds remote to blacklist", function()
    if SelectedLogIndex and getgenv().SlenderSpy.Logs[SelectedLogIndex] then
        local Log = getgenv().SlenderSpy.Logs[SelectedLogIndex]
        table.insert(getgenv().SlenderSpy.Blocked, Log.Name)
        Window:Notify("Blocked", Log.Name .. " added to blacklist", 2)
    else
        Window:Notify("Error", "Select a remote first!", 2)
    end
end)

TabSpy:Button("âš¡ Instant Replay", "Re-executes selected remote", function()
    if SelectedLogIndex and getgenv().SlenderSpy.Logs[SelectedLogIndex] then
        local Log = getgenv().SlenderSpy.Logs[SelectedLogIndex]
        if Log.Instance then
            pcall(function()
                if Log.Method == "FireServer" then
                    Log.Instance:FireServer(unpack(Log.Args))
                elseif Log.Method == "InvokeServer" then
                    task.spawn(function() Log.Instance:InvokeServer(unpack(Log.Args)) end)
                end
            end)
            Window:Notify("Replayed", "Remote executed again", 1)
        end
    else
        Window:Notify("Error", "Select a remote first!", 2)
    end
end)

TabSpy:Section("Code Generation")

TabSpy:Button("â¬‡ï¸ GENERATE & PREVIEW â¬‡ï¸", "Creates Lua code from remote", function()
    if SelectedLogIndex and getgenv().SlenderSpy.Logs[SelectedLogIndex] then
        local Log = getgenv().SlenderSpy.Logs[SelectedLogIndex]
        local Code = GenerateScript(Log)
        
        CurrentScriptBuffer = Code
        
        if CodePreview then
            CodePreview:Set(Code)
        end
        
        Window:Notify("Generated", "Code created successfully!", 1)
    else
        Window:Notify("Error", "Select a remote first!", 2)
    end
end)

CodePreview = TabSpy:Input("Script Preview", "Generated code appears here...", "CodeBuffer", "Edit code before execution", function(Text)
    CurrentScriptBuffer = Text
end)

TabSpy:Button("ðŸ“‹ Copy to Clipboard", "Copies code to clipboard", function()
    if CurrentScriptBuffer ~= "" then
        if setclipboard then
            setclipboard(CurrentScriptBuffer)
            Window:Notify("Copied", "Code copied to clipboard!", 1)
        else
            Window:Notify("Error", "Clipboard not supported", 2)
        end
    else
        Window:Notify("Error", "No code to copy!", 2)
    end
end)

TabSpy:Button("â–¶ Execute Generated Code", "Runs the generated script", function()
    if CurrentScriptBuffer ~= "" then
        local success, result = pcall(function()
            local func, syntaxErr = loadstring(CurrentScriptBuffer)
            if not func then error(syntaxErr) end
            func()
        end)
        
        if success then
            Window:Notify("Success", "Script executed successfully", 1)
        else
            Window:Notify("Error", "Execution failed: " .. tostring(result), 3)
        end
    else
        Window:Notify("Error", "No code to execute!", 2)
    end
end)

-- ==========================================
-- CORE LOGIC: HYBRID HOOK SYSTEM
-- ==========================================

local function ProcessLog(Instance, Method, Args)
    if not getgenv().SlenderSpy.Enabled then return end
    
    local RemoteName = Instance.Name
    for _, v in pairs(getgenv().SlenderSpy.Blocked) do
        if RemoteName == v then return end
    end

    local SrcScript = getcallingscript and getcallingscript()
    local SrcPath = "Unknown"
    if SrcScript then
        SrcPath = SrcScript:GetFullName()
    end

    local Logs = getgenv().SlenderSpy.Logs
    local LastLog = Logs[#Logs]

    if LastLog and LastLog.Instance == Instance and DeepCompare(LastLog.Args, Args) then
        LastLog.Count = LastLog.Count + 1
        LastLog.Time = os.date("%X")
    else
        table.insert(Logs, {
            Name = RemoteName,
            Instance = Instance,
            Method = Method,
            Args = Args,
            Source = SrcPath,
            Time = os.date("%X"),
            Count = 1
        })
        
        -- Memory Management: Remove old logs
        if #Logs > getgenv().SlenderSpy.MaxLogs then
            table.remove(Logs, 1)
        end
    end
end

-- 1. Hook Metamethod (__namecall)
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    local args = {...}
    
    if (method == "FireServer" or method == "InvokeServer") then
        ProcessLog(self, method, args)
    end
    
    return oldNamecall(self, ...)
end)

setreadonly(mt, true)

-- 2. Hook Function (Direct Calls)
local HookSuccess = pcall(function()
    getgenv().SlenderSpy_OldFireServer = hookfunction(Instance.new("RemoteEvent").FireServer, newcclosure(function(self, ...)
        ProcessLog(self, "FireServer", {...})
        return getgenv().SlenderSpy_OldFireServer(self, ...)
    end))
    
    getgenv().SlenderSpy_OldInvokeServer = hookfunction(Instance.new("RemoteFunction").InvokeServer, newcclosure(function(self, ...)
        ProcessLog(self, "InvokeServer", {...})
        return getgenv().SlenderSpy_OldInvokeServer(self, ...)
    end))
end)

if not HookSuccess then
    warn("[SlenderHub Spy] Function hooks failed - using metamethod only")
end

-- 3. Hook UnreliableRemoteEvent
pcall(function()
    local Unreliable = Instance.new("UnreliableRemoteEvent")
    getgenv().SlenderSpy_OldUnreliableFire = hookfunction(Unreliable.FireServer, newcclosure(function(self, ...)
        ProcessLog(self, "FireServer", {...})
        return getgenv().SlenderSpy_OldUnreliableFire(self, ...)
    end))
end)

Window:Notify("SlenderHub Spy V3.0", "Remote monitoring active!", 3)
