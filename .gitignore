--!strict
--[[
    Slender Hub - INTELLIGENT TIER SYSTEM (V2.3 - FINAL)
    Status: âœ… Pickaxe Simulator Added
    Status: âœ… The Forge Added
    Status: âœ… Tap Simulator Added (ID: 75992362647444)
    Links: âœ… Auto-Fixed (Removed 'refs/heads' to prevent HttpGet Errors)
]]

--//==============================[ SERVICES ]==============================//--
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local MarketService = game:GetService("MarketplaceService")

local LocalPlayer = Players.LocalPlayer
local CurrentPlaceId = game.PlaceId

--//==============================[ âš  CONFIGURAÃ‡ÃƒO DE IDs (COMPLETA) ]==============================//--
local VELINK_IDS = {
    -- [ID DO LINK] = {Tipo, Segundos}
    
    -- âœ… ID DE 7 DIAS (PREMIUM)
    ["ed6453e6-5259-49b4-8779-05b866831dc2"] = {Type = "Premium", Duration = 604800}, 
    
    -- âœ… ID DE 30 DIAS (PREMIUM)
    ["2c69fdcf-f8e1-4c1a-9270-f36d9545ebce"] = {Type = "Premium", Duration = 2592000}
    
    -- NOTA: Qualquer ID que NÃƒO for um desses dois, serÃ¡ considerado FREE (24h) automaticamente.
}

local Config = {
    FOLDER = "SlenderHub_Universal", 
    FILE = "KeyData_" .. LocalPlayer.UserId .. ".json",
    VELINK_CHECK_URL = "https://velink.to/api/public/check/key",
    
    -- Links
    FREE_KEY_LINK = "https://velink.to/u/678807",
    PREMIUM_SHOP_URL = "https://www.slenderhub.shop/"
}

--//==============================[ JOGOS SUPORTADOS ]==============================//--
local GAMES_MAP = {
    -- âœ… PICKAXE SIMULATOR
    [82013336390273] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/Pickaxe%20Simulator%20script",

    -- âœ… BEE TAPPERS
    [107807115409153] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/Bee%20Tappers%20Script",
    
    -- âœ… STEAL A BRAINROT
    [109983668079237] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/Steal%20a%20Brainrot(Free)",

    -- âœ… THE FORGE
    [76558904092080] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/The%20Forge%20Script",

    -- âœ… TAP SIMULATOR (ADICIONADO E CORRIGIDO)
    [75992362647444] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/Tap%20simulator"
}

local TARGET_SCRIPT_URL = GAMES_MAP[CurrentPlaceId]

--//==============================[ CHAVES LIFETIME ]==============================//--
local LIFETIME_KEYS = {
    ["LifeTimeF4K9L2P7V8JDHUtY"] = true,
    ["SlenderDevKey"] = true
}

local FILE_PATH = Config.FOLDER .. "/" .. Config.FILE
local isAccessAuthorized = false
local authorizedKeyType = "Free"
local authorizedDuration = 86400

--//==============================[ VALIDAÃ‡ÃƒO INTELIGENTE ]==============================//--
local function verifyKeyWithAPI(inputKey)
    -- 1. Checa Lifetime (Manual)
    if LIFETIME_KEYS[inputKey] then
        return "Premium", math.huge
    end

    -- 2. ValidaÃ§Ã£o API VeLink
    local requestUrl = string.format("%s?key=%s", Config.VELINK_CHECK_URL, inputKey)
    local requestFunc = (syn and syn.request) or (http and http.request) or (http_request) or (request)
    
    if not requestFunc then return nil, nil end

    local response = requestFunc({Url = requestUrl, Method = "GET"})

    if response and response.StatusCode == 200 then
        local success, data = pcall(function() return HttpService:JSONDecode(response.Body) end)
        
        if success and data and data.expired == false then
            local unlockerId = tostring(data.unlockerId)
            
            print("ðŸ” [SLENDER HUB] ID Validado: " .. unlockerId)
            
            local tierInfo = VELINK_IDS[unlockerId]
            
            if tierInfo then
                return tierInfo.Type, tierInfo.Duration
            else
                return "Free", 86400
            end
        end
    end

    return nil, nil
end

--//==============================[ SISTEMA LOCAL ]==============================//--
local function formatTime(seconds)
    if seconds == math.huge then return "Lifetime" end
    local days = math.floor(seconds / 86400)
    local hours = math.floor((seconds % 86400) / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    return string.format("%dd %02dh %02dm", days, hours, minutes)
end

local function loadGameScript(accessLevel)
    if not TARGET_SCRIPT_URL then 
        warn("ðŸ”´ [Slender Hub] Script URL not found for Place ID: " .. CurrentPlaceId)
        StarterGui:SetCore("SendNotification", {Title = "Slender Hub", Text = "Game Not Supported (Check ID)", Duration = 5})
        return 
    end
    
    -- Define a variÃ¡vel global para o script do jogo saber se Ã© Free ou Premium
    if getgenv then 
        getgenv().SlenderHubAccessLevel = accessLevel
    else 
        _G.SlenderHubAccessLevel = accessLevel 
    end
    
    -- Carrega o script com proteÃ§Ã£o de erro
    task.spawn(function() 
        local success, err = pcall(function()
            loadstring(game:HttpGet(TARGET_SCRIPT_URL))() 
        end)
        if not success then
            warn("Failed to load script: " .. tostring(err))
            StarterGui:SetCore("SendNotification", {Title = "Error", Text = "Failed to load script! Check Console (F9)", Duration = 5})
        end
    end)
end

local function saveKey(keyType, keyContent, duration)
    if not isfolder(Config.FOLDER) then makefolder(Config.FOLDER) end
    local data = {
        Type = keyType, 
        Key = keyContent, 
        Time = os.time(),
        CustomDuration = duration
    }
    writefile(FILE_PATH, HttpService:JSONEncode(data))
end

local function checkLocalKey()
    if not isfile(FILE_PATH) then return false, nil end
    local success, data = pcall(function() return HttpService:JSONDecode(readfile(FILE_PATH)) end)
    if not success or not data or not data.Time then delfile(FILE_PATH); return false, nil end

    local duration = data.CustomDuration or 86400
    if duration == math.huge then return true, data, math.huge end

    local elapsed = os.time() - data.Time
    if elapsed > duration then
        delfile(FILE_PATH); return false, nil
    end
    return true, data, (duration - elapsed)
end

--//==============================[ AUTO-EXECUTE ]==============================//--
local isSaved, savedData, remainingTime = checkLocalKey()

if isSaved and TARGET_SCRIPT_URL then
    local timeMsg = (remainingTime == math.huge) and "Lifetime Access" or formatTime(remainingTime)
    StarterGui:SetCore("SendNotification", {Title = "Slender Hub", Text = "Auto-Login! Remaining: " .. timeMsg, Duration = 8})
    loadGameScript(savedData.Type)
    return 
end

--//==============================[ UI RAYFIELD (LOGIN) ]==============================//--
local success, Rayfield = pcall(function() return loadstring(game:HttpGet("https://sirius.menu/rayfield"))() end)
if not success then return end

local Window = Rayfield:CreateWindow({
    Name = "Slender Hub | Universal",
    LoadingTitle = "Slender Hub",
    LoadingSubtitle = "VeLink Integration",
    ConfigurationSaving = { Enabled = false },
    Discord = { Enabled = false },
})

local Tab = Window:CreateTab("Access", 4483362458)
local Section = Tab:CreateSection("Authentication")

-- Tenta pegar o nome do jogo, se falhar usa "Unknown"
local gameName = "Unknown Game"
pcall(function() gameName = MarketService:GetProductInfo(CurrentPlaceId).Name end)

local statusText = TARGET_SCRIPT_URL and "âœ… Supported: " .. gameName or "âš  Unsupported Game"

Tab:CreateParagraph({Title = "Status", Content = statusText .. "\n(ID: " .. CurrentPlaceId .. ")"})

Tab:CreateInput({
    Name = "Enter Key",
    PlaceholderText = "Paste Key (VELINK-XXXX)...",
    RemoveTextAfterFocusLost = false,
    Callback = function(input)
        local key = input:gsub("%s+", "") -- Remove espaÃ§os acidentais
        
        Rayfield:Notify({Title = "Checking API...", Content = "Verifying Tier & Duration...", Duration = 2})
        
        local keyType, keyDuration = verifyKeyWithAPI(key)
        
        if keyType and keyDuration then
            isAccessAuthorized = true
            authorizedKeyType = keyType
            authorizedDuration = keyDuration
            saveKey(keyType, key, keyDuration)
            
            local durText = (keyDuration == math.huge) and "Lifetime" or formatTime(keyDuration)
            Rayfield:Notify({Title = "Success!", Content = keyType .. " Key Validated (" .. durText .. ")", Duration = 5})
        else
            isAccessAuthorized = false
            Rayfield:Notify({Title = "Invalid Key", Content = "Expired or Does not Exist.", Duration = 3})
        end
    end,
})

Tab:CreateButton({
    Name = "ðŸš€ Launch Hub",
    Callback = function()
        if not isAccessAuthorized then
            Rayfield:Notify({Title = "Access Denied", Content = "Please enter a valid key.", Duration = 3})
            return
        end
        
        if not TARGET_SCRIPT_URL then
             Rayfield:Notify({Title = "Error", Content = "Script not available for this game.", Duration = 3})
             return
        end
        
        local isSaved, data, remaining = checkLocalKey()
        local timeMsg = (remaining == math.huge) and "Lifetime" or formatTime(remaining)
        StarterGui:SetCore("SendNotification", {Title = "Access Granted", Text = "Remaining: " .. timeMsg, Duration = 5})

        Rayfield:Destroy()
        task.wait(0.5)
        loadGameScript(authorizedKeyType)
    end,
})

local KeySection = Tab:CreateSection("Get Access")

Tab:CreateButton({
    Name = "ðŸ”‘ Get Free Key (24h)",
    Callback = function()
        setclipboard(Config.FREE_KEY_LINK)
        Rayfield:Notify({Title = "Copied", Content = "Link copied!", Duration = 2})
    end,
})

Tab:CreateButton({
    Name = "ðŸ’Ž Buy Premium (Shop)",
    Callback = function()
        setclipboard(Config.PREMIUM_SHOP_URL)
        Rayfield:Notify({Title = "Shop Copied", Content = "Visit SlenderHub.shop", Duration = 3})
    end,
})
