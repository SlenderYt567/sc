--!strict
--[[
    SlenderHub - UNIVERSAL LOADER (Architect Edition V10)
    Architecture: Singleton / Factory Pattern
    UI Library: SlenderWind V5 (Internal V10 Standard)
    Security: VeLink Integration + Hybrid Hooking
]]

--//==============================[ 0. CORE INITIALIZATION ]==============================//--
local Services = {
    HttpService = game:GetService("HttpService"),
    Players = game:GetService("Players"),
    MarketplaceService = game:GetService("MarketplaceService"),
    CoreGui = game:GetService("CoreGui"),
    RunService = game:GetService("RunService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage")
}

local LocalPlayer = Services.Players.LocalPlayer
local CurrentPlaceId = game.PlaceId

-- Singleton Check
if getgenv().SlenderHubLoaded then
    warn("[SlenderHub] Instance already running.")
    return
end
getgenv().SlenderHubLoaded = true

--//==============================[ 1. CONFIGURATION ]==============================//--
local Config = {
    Folder = "SlenderHub_Data",
    File = "Auth_" .. LocalPlayer.UserId .. ".json",
    VeLink_Check = "https://velink.to/api/public/check/key",
    Free_Key_Link = "https://velink.to/u/678807",
    Shop_Link = "https://www.slenderhub.shop/",
    Theme = { Accent = Color3.fromRGB(0, 255, 128) } -- Slender Green
}

-- Game Database (From your input)
local GAMES_MAP = {
    [93787311916283] = "https://raw.githubusercontent.com/SlenderYt567/sc/refs/heads/main/Horse%20Race",
    [82013336390273] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/Pickaxe%20Simulator%20script",
    [107807115409153] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/Bee%20Tappers%20Script",
    [109983668079237] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/Steal%20a%20Brainrot(Free)",
    [76558904092080] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/The%20Forge%20Script",
    [75992362647444] = "https://raw.githubusercontent.com/SlenderYt567/sc/main/Tap%20simulator",
    [4924922222] = "https://raw.githubusercontent.com/SlenderYt567/sc/refs/heads/main/Brookhaven%20script"
}

local VELINK_IDS = {
    ["ed6453e6-5259-49b4-8779-05b866831dc2"] = {Type = "Premium", Duration = 604800},
    ["2c69fdcf-f8e1-4c1a-9270-f36d9545ebce"] = {Type = "Premium", Duration = 2592000}
}

local LIFETIME_KEYS = {
    ["LifeTimeF4K9L2P7V8JDHUtY"] = true,
    ["SlenderDevKey"] = true
}

--//==============================[ 2. UTILITIES ]==============================//--
local Utils = {}

function Utils.FormatTime(seconds)
    if seconds == math.huge then return "Lifetime" end
    local days = math.floor(seconds / 86400)
    local hours = math.floor((seconds % 86400) / 3600)
    return string.format("%dd %02dh", days, hours)
end

function Utils.SaveKey(key, type, duration)
    if not isfolder(Config.Folder) then makefolder(Config.Folder) end
    local data = {Key = key, Type = type, Time = os.time(), Duration = duration}
    writefile(Config.Folder .. "/" .. Config.File, Services.HttpService:JSONEncode(data))
end

function Utils.LoadKey()
    local path = Config.Folder .. "/" .. Config.File
    if not isfile(path) then return nil end
    local success, result = pcall(function() 
        return Services.HttpService:JSONDecode(readfile(path)) 
    end)
    if not success then return nil end
    
    local elapsed = os.time() - result.Time
    if elapsed > result.Duration then 
        delfile(path)
        return nil 
    end
    return result, (result.Duration - elapsed)
end

function Utils.VerifyKey(inputKey)
    if LIFETIME_KEYS[inputKey] then return "Dev/Lifetime", math.huge end
    
    local requestFunc = (syn and syn.request) or (http and http.request) or (http_request) or (request)
    if not requestFunc then return "Executor Unsupported", 0 end

    local url = string.format("%s?key=%s", Config.VeLink_Check, inputKey)
    local response = requestFunc({Url = url, Method = "GET"})

    if response and response.StatusCode == 200 then
        local success, data = pcall(function() return Services.HttpService:JSONDecode(response.Body) end)
        if success and data and data.expired == false then
            local tier = VELINK_IDS[tostring(data.unlockerId)]
            if tier then return tier.Type, tier.Duration end
            return "Free", 86400 -- Default 24h
        end
    end
    return nil
end

--//==============================[ 3. UI INITIALIZATION ]==============================//--
local SlenderWind = loadstring(game:HttpGet("https://raw.githubusercontent.com/SlenderYt567/sc/refs/heads/main/SlenderWindV5.lua"))()
local Window = SlenderWind.Window({
    Name = "SlenderHub | Architect V10",
    KeySystem = false, -- We handle our own custom key system logic
    Theme = Config.Theme
})

--//==============================[ 4. TABS & LOGIC ]==============================//--

-- [TAB 1] AUTHENTICATION
local AuthTab = Window:Tab("Authentication")
local KeyInputVal = ""

AuthTab:Label("Status: " .. (Utils.LoadKey() and "Authenticated" or "Locked"))

AuthTab:Input("License Key", "Paste Key Here...", "AuthKey", "VeLink Key", function(val)
    KeyInputVal = val
end)

AuthTab:Button("Verify Key", "Check with Server", function()
    if KeyInputVal == "" then return end
    local type, duration = Utils.VerifyKey(KeyInputVal)
    
    if type then
        Utils.SaveKey(KeyInputVal, type, duration)
        Window:Notify("Success", "Key Validated: " .. type, 5)
        task.wait(1)
        -- Refresh UI or Auto-Load
    else
        Window:Notify("Error", "Invalid or Expired Key", 3)
    end
end)

AuthTab:Button("Get Key (Link)", "Copy to Clipboard", function()
    setclipboard(Config.Free_Key_Link)
    Window:Notify("System", "Link Copied to Clipboard", 2)
end)

-- [TAB 2] LOADER (Game Detection)
local LoaderTab = Window:Tab("Game Loader")

local GameName = "Unknown"
pcall(function() GameName = Services.MarketplaceService:GetProductInfo(CurrentPlaceId).Name end)
local IsSupported = GAMES_MAP[CurrentPlaceId] ~= nil

LoaderTab:Paragraph("Current Game", GameName .. "\nID: " .. CurrentPlaceId)
LoaderTab:Label(IsSupported and "✅ Supported" or "⚠ Universal Mode Only")

LoaderTab:Button("Load Script", "Execute Game Script", function()
    local savedKey = Utils.LoadKey()
    if not savedKey then
        Window:Notify("Access Denied", "Please Verify Key First", 3)
        return
    end

    if IsSupported then
        Window:Notify("Loader", "Injecting Script...", 3)
        loadstring(game:HttpGet(GAMES_MAP[CurrentPlaceId]))()
    else
        Window:Notify("Loader", "Game not supported. Use Universal Tab.", 3)
    end
end)

-- [TAB 3] UNIVERSAL (Spy & Tools)
local UniTab = Window:Tab("Universal")

-- Spy State
getgenv().SlenderSpy = {
    Enabled = false,
    Logs = {},
    Blocked = {"CharacterSoundEvent", "UpdateMouse", "Move", "TouchHeartbeat"}
}

UniTab:Toggle("Remote Spy", false, "SpyToggle", "Hybrid Hook", function(val)
    getgenv().SlenderSpy.Enabled = val
    if val then
        Window:Notify("Spy", "Hooking Metamethods...", 2)
        -- Simple Hook Implementation
        local mt = getrawmetatable(game)
        local oldNamecall = mt.__namecall
        setreadonly(mt, false)
        
        mt.__namecall = newcclosure(function(self, ...)
            local method = getnamecallmethod()
            local args = {...}
            
            if getgenv().SlenderSpy.Enabled and (method == "FireServer" or method == "InvokeServer") then
                local blocked = false
                for _, v in pairs(getgenv().SlenderSpy.Blocked) do
                    if self.Name == v then blocked = true break end
                end
                
                if not blocked then
                    print("Remote: " .. self.Name .. " | Method: " .. method)
                    -- In a full version, we would push to UI here
                end
            end
            return oldNamecall(self, ...)
        end)
        setreadonly(mt, true)
    end
end)

UniTab:Button("Dump Remotes (Console)", "Print to F9", function()
    Window:Notify("Spy", "Check F9 Console", 2)
    print("--- SlenderHub Remote Dump ---")
    -- Logic to dump would go here
end)

UniTab:Button("Clear Cache", "Clean Memory", function()
    getgenv().SlenderSpy.Logs = {}
    Window:Notify("System", "Memory Cleared", 2)
end)

--//==============================[ 5. AUTO-EXECUTE LOGIC ]==============================//--
task.spawn(function()
    local savedKey, remaining = Utils.LoadKey()
    if savedKey then
        Window:Notify("Auto-Auth", "Welcome back! (" .. Utils.FormatTime(remaining) .. ")", 5)
        if IsSupported then
            -- Optional: Auto-load script if key is valid
            -- loadstring(game:HttpGet(GAMES_MAP[CurrentPlaceId]))()
        end
    end
end)
